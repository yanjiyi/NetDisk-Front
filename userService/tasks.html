<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>我的事务</title>
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <script src="../js/bootstrap.min.js" type="text/javascript"></script>
  <script src="../js/jquery-3.6.0.min.js" type="text/javascript"></script>
  <script src="../js/JSPager.js" type="text/javascript"></script>
  <script src="../js/utils.js" type="text/javascript"></script>
  <style type="text/css">
    #mainDlg {
      /* width: 80%; */
      margin: 0 auto;
      margin-top: 10%;
      border-radius: 10px;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 15px 25px rgba(0, 0, 0, .5);
      padding: 20px;
    }

    .container {
      border-radius: 10px;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 15px 25px rgba(0, 0, 0, .5);
      padding: 20px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* .nav-item {
				margin: 10px 0px;
			} */

    ul>li {
      list-style: none;
    }

    body .modal-dialog {
      /* Width */
      max-width: 100%;
      width: auto !important;
      display: inline-block;
    }

    .modal {
      z-index: -1;
      /* display: flex !important; */
      /* justify-content: center;
      align-items: center; */
    }

    .modal-open .modal {
      z-index: 1100 !important;
    }
  </style>
</head>

<body style="background-image: url(../img/74279906_p0.png);background-attachment: fixed;
				background-size: cover;height: 100%;">
  <div class="container">
    <div class="header" style="height: 80px;">
      <ul>
        <li style="float: left;padding-right: 50px;">
          <ul>
            <li class="nav-item" style="padding-bottom: 10px;">
              <img src="../img/QQ图片20210929135729.jpg" style="width: 100px;height: 100px;border-radius: 50px;"
                id="userImg" />
            </li>
            <li>
              <span class="text-center text-primary" style="font-size: 30px;line-height: 30px;"
                id="userNickName">酸奶红豆包</span>
            </li>
          </ul>
        </li>
        <li style="float: left;">
          <nav nav class="navbar navbar-light"
            style="background-color: #e3f2fd;background-color: transparent;font-size: 30px;">
            <!-- <div class="container-fluid">
						
							</div> -->
            <ul class="nav nav-pills">
              <li class="nav-item">
                <a class="nav-link" href="filelist.html">文件列表</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="friends.html">好友列表</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="tasks.html">我的事务</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="sharefile.html">分享文件</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="userprofile.html">个人信息</a>
              </li>
            </ul>
          </nav>
        </li>
      </ul>
    </div>
    <div id="mainDlg" class="text-center bg-gradient tab-content">
      <nav nav class="navbar navbar-light">
        <ul class="nav nav-pills">
          <li class="nav-item" style="padding-right: 30px;">
            <select id="taskname" class="btn">
              <option value="ToMyTasks" selected>和我相关的事务</option>
              <option value="MyTasks">我创建的事务</option>
            </select>
          </li>
          <li class="nav-item" style="padding-right: 30px;">
            <select id="tasktype" class="btn">
              
            </select>
          </li>
          <li class="nav-item" style="padding-right: 30px;">
            <button class="btn btn-outline-primary" onclick="onGetClick()">获取</button>
          </li>
        </ul>
      </nav>
      <table class="table table-borderless table-hover table-striped table-responsive" id="task_table">
        <tr class="table-active">
          <td>事务ID</td>
          <td>事务类型</td>
          <td>发起用户</td>
          <td>目标用户</td>
          <td>创建日期</td>
          <td>事务状态</td>
          <td>事务是否已被处理</td>
          <td>操作</td>
        </tr>

        <tbody id="tasks_container">

        </tbody>


      </table>
      <nav>
        <ul class="pagination justify-content-center">
          <li class="page-item">
            <a class="page-link" href="#" onclick="page.firstPage();">首页</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#" onclick="page.prePage();">上一页</a>
          </li>
          <li class="page-item">
            <span class="page-link" id="pageindex"></span>
          </li>
          <li class="page-item">
            <a class="page-link" href="#" onclick="page.nextPage();">下一页</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#" onclick="page.lastPage();">尾页</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <script type="text/javascript">
    var page = null

    $.ajax({
      url: "/api/getUser",
      type: "POST",
      success: function (data) {
        if (null != data && "" != data) {
          document.getElementById("userImg").setAttribute("src", "/api/download?recorid=" + data
            .imgserviceid)
          document.getElementById("userNickName").innerHTML = data.nickname
        } else {
          alert("获取用户信息失败！")
          window.location.href = '../index.html'
        }
      },
      error: function () {
        alert("获取用户信息失败！")
        window.location.href = '../index.html'
      }
    })

    var tasktype_list = []

    var first = true;

    $.ajax({
      url:"/api/listAllTaskType",
      type:"POST",
      success:function(data){
        for(var i = 0;i<data.length;i++)
        {
          if(data[i].taskname!="Download")
          {
            $('#tasktype').append("<option value='"+data[i].id+"'>"+ data[i].taskname +"</option>")
            tasktype_list.push(data[i])
          }
        }

        $("#tasktype option[value='1']").prop("selected",true)


        $('#taskname').change(function(){
            if($("#taskname").find("option:selected").text()==="和我相关的事务")
            {
              $("#tasktype").empty()
              for(var k=0;k<tasktype_list.length;k++)
              {
                if(tasktype_list[k].taskname!="Download")
                {
                  $('#tasktype').append("<option value='"+tasktype_list[k].id+"'>"+ tasktype_list[k].taskname +"</option>")
                }
              }
            }else{
              $("#tasktype").empty()
              for(var k=0;k<tasktype_list.length;k++)
              {
                $('#tasktype').append("<option value='"+tasktype_list[k].id+"'>"+ tasktype_list[k].taskname +"</option>")
              }
            }
        })

        onGetClick()
      },
      error:function()
      {
        alert("获取事务类型失败！")
      }
    })

    function findTaskTypeName(id)
    {
      for(var i=0;i<tasktype_list.length;i++)
      {
        if(tasktype_list[i].id === id)
        {
          return tasktype_list[i].taskname
        }
      }

      return "不明事务"
    }

    function DeleteTask(id)
    {

    }

    function Detial(id)
    {

    }

    function onGetClick()
    {
      var tasktype_id = $("#tasktype").find("option:selected").val()
      var taskname = $("#taskname").find("option:selected").val()

      var xhr = new XMLHttpRequest()
      if(taskname==="ToMyTasks")
      {
        xhr.open("POST","/api/listToMyTask",false)
      }else{
        xhr.open("POST","/api/listMyTask",false)
      }

      xhr.send(null)

      $("#tasks_container").empty()
      var data = JSON.parse(xhr.responseText)
      var tdArr = document.getElementById("tasks_container")

      for(var i=0;i<data.length;i++)
      {
        if(tasktype_id === data[i].tasktype)
        {
          xhr.open("POST","/api/getUserName?id="+data[i].userid,false)
          xhr.send(null)
          var userName = xhr.responseText
          
          xhr.open("POST","/api/getUserName?id="+data[i].targetid,false)
          xhr.send(null)
          var targetName = xhr.responseText

          var td = document.createElement("td")
          td.innerHTML = "<td>" + data[i].id + "</td><td>" +  findTaskTypeName(data[i].tasktype) + "</td><td>" + userName + "</td><td>" + targetName + "</td><td>" + timestampToTime(data[i].date) + "</td><td>" + (data[i].taskstatus ? "正常" : "等待") + "</td><td>" + (data[i].idle ? "已被处理" : "未被处理") + "</td><td><button class='btn btn-outline-danger' onclick='DeleteTask(" + data[i].id + ")'>删除</button><button class='btn btn-outline-secondary' onclick='Detial(" + data[i].id + ")'>详细</button></td>";
          tdArr.appendChild(td)
        }
      }

      if(first)
      {
        page = new Page(5,'task_table','tasks_container','pageindex')
      }else{
        page.reload()
      }
    }
  </script>
</body>

</html>