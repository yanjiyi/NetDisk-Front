<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>文件列表</title>
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <script src="../js/bootstrap.min.js" type="text/javascript"></script>
  <script src="../js/jquery-3.6.0.min.js" type="text/javascript"></script>
  <script src="../js/utils.js" type="text/javascript"></script>
  <script src="../js/spark-md5.min.js" type="text/javascript"></script>
  <style type="text/css">
    #mainDlg {
      /* width: 80%; */
      margin: 0 auto;
      margin-top: 10%;
      border-radius: 10px;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 15px 25px rgba(0, 0, 0, .5);
      padding: 20px;
    }

    .container {
      border-radius: 10px;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 15px 25px rgba(0, 0, 0, .5);
      padding: 20px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .nav-item {
      margin: 10px 0px;
    }

    ul>li {
      list-style: none;
    }

    body .modal-dialog {
      /* Width */
      max-width: 100%;
      width: auto !important;
      display: inline-block;
    }

    .modal {
      z-index: -1;
      display: flex !important;
      justify-content: center;
      align-items: center;
    }

    .modal-open .modal {
      z-index: 1;
    }
  </style>
</head>

<body style="background-image: url(../img/74279906_p0.png);background-attachment: fixed;
				background-size: cover;height: 100%;">
  <div class="container">
    <div class="header" style="height: 80px;">
      <ul>
        <li style="float: left;padding-right: 50px;">
          <ul>
            <li class="nav-item">
              <img src="../img/QQ图片20210929135729.jpg" style="width: 100px;height: 100px;border-radius: 50px;"
                id="userImg" />
            </li>
            <li>
              <span class="text-center" style="color: greenyellow;font-size: 30px;line-height: 30px;"
                id="userNickName">酸奶红豆包</span>
            </li>
          </ul>
        </li>
        <li style="float: left;">
          <nav nav class="navbar navbar-light"
            style="background-color: #e3f2fd;background-color: transparent;height: 80px;line-height: 80px;">
            <!-- <div class="container-fluid">
						
							</div> -->
            <ul class="nav nav-pills">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">文件列表</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="friends.html">好友列表</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="tasks.html">我的事务</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="sharefile.html">分享文件</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="userprofile.html">个人信息</a>
              </li>
            </ul>
          </nav>
        </li>
      </ul>
    </div>

    <div id="mainDlg" class="bg-gradient flex-column">
      <nav nav class="navbar navbar-light">
        <ul class="nav nav-pills">
          <li class="nav-item dropdown" style="padding-right: 30px;">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
              aria-expanded="false">上传</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#uploadFileModal">上传文件</a>
              </li>
              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#uploadDirModal">上传文件夹</a>
              </li>
            </ul>
          </li>
          <li class="nav-item" style="padding-right: 30px;">
            <button class="btn btn-outline-primary">创建文件夹</button>
          </li>
          <li class="nav-item" style="padding-right: 30px;">
            <button class="btn btn-outline-primary">转到路径...</button>
          </li>
          <li class="nav-item" style="padding-right: 30px;">
            <button class="btn btn-outline-primary" onclick="onRetClick()">返回</button>
          </li>
        </ul>
      </nav>

      <table class="table table-borderless table-hover table-responsive">
        <tr class="table-active">
          <td>文件名</td>
          <td>文件类型</td>
          <td>上传日期</td>
          <td>状态</td>
          <td>操作</td>
          <td></td>
        </tr>
        <tbody id="files_container">

        </tbody>
      </table>
    </div>
  </div>

  <div class="modal fade" id="serverErrorModal" tabindex="-1" aria-labelledby="serverErrorModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="serverErrorModal">服务器错误</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h2 class="bg-danger">请求服务器异常！</h2>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade text-center" id="detialModal" tabindex="-1" aria-labelledby="detialModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detialModal">详细信息</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h5 class="text-center">Service表信息</h5>
          <table class="table table-borderless table-hover table-striped">
            <tr>
              <td>ID</td>
              <td>用户ID</td>
              <td>文件名</td>
              <td>系统文件表ID</td>
              <td>状态</td>
              <td>上传日期</td>
              <td>父Service记录ID</td>
              <td>是否是文件夹</td>
            </tr>
            <tr id="detialServiceInfo">

            </tr>
          </table>
          <h5 class="text-center">系统文件表信息</h5>
          <table class="table table-borderless table-hover table-striped">
            <tr>
              <td>ID</td>
              <td>文件名</td>
              <td>文件MD5</td>
              <td>文件位置</td>
              <td>文件大小</td>
              <td>启用</td>
              <td>Root标志</td>
            </tr>
            <tr id="detialSysFileTabInfo">

            </tr>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade text-center" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModal"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadFileModal">上传文件</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-borderless table-hover">
            <tr class="row">
              <td><input type="file" id="upload_file" /></td>
            </tr>
            <tr class="row">
              <!-- <td>上传进度：</td> -->
              <td>
                <div class="progress">
                  <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar"
                    aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%" id="upload_progress">上传进度
                  </div>
                </div>
              </td>
            </tr>
            <tr class="row">
              <!-- <td>计算文件指纹：</td> -->
              <td>
                <div class="progress">
                  <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar"
                    aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%" id="filehash_progress">
                    计算文件指纹</div>
                </div>
              </td>
            </tr>
            <tr class="row">
              <td>
                <pre id=log></pre>
              </td>
            </tr>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="stopUploadFile()">关闭</button>
          <button type="button" class="btn btn-primary" onclick="uploadFile()">上传</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade text-center" id="uploadDirModal" tabindex="-1" aria-labelledby="uploadDirModal"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadDirModal">上传文件夹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="display: inline-block; width: 800px;">
          <table class="table table-borderless table-hover">
            <tr class="row">
              <td><input type="file" id="upload_dir" webkitdirectory directory /></td>
            </tr>
            <tr class="row">
              <!-- <td>上传进度：</td> -->
              <td>
                <!-- <div class="progress">
										<div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
											role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"
											style="width: 0%" id="uploaddir_progress"></div>
									</div> -->
                <span id="upload_action"></span>
              </td>
            </tr>
            <tr class="row">
              <!-- <td>计算文件指纹：</td> -->
              <td>
                <div class="progress">
                  <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar"
                    aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"
                    id="filehashdir_progress">计算文件指纹</div>
                </div>
              </td>
            </tr>
            <tr class="row">
              <td>
                <pre id=log_dir></pre>
              </td>
              <td>
                <pre id="cacl_result"></pre>
              </td>
              <td>
                <pre id="status"></pre>
              </td>
            </tr>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="stopUpLoadDir()">关闭</button>
          <button type="button" class="btn btn-primary" onclick="uploadDir()">上传</button>
        </div>
      </div>
    </div>
  </div>

</body>
<script type="text/javascript">
  var serverErrorModal = new bootstrap.Modal(document.getElementById('serverErrorModal'), {
    keyboard: false
  })

  var detialModal = new bootstrap.Modal(document.getElementById('detialModal'), {
    keyboard: false
  })

  $.ajax({
    type: "POST",
    url: "/api/listCur",
    success: function (data) {

      var tdArr = document.getElementById("files_container")
      for (var i = 0; i < data.length; i++) {
        var tr = document.createElement("tr");
        tr.style.lineHeight = '38px';
        tr.innerHTML = "<td>" + data[i].userfilename + "</td>" + "<td>" + (data[i].dirmask ? "文件夹" : "文件") +
          "</td>" + "<td>" + timestampToTime(data[i]
            .uploaddate) + "</td><td>" + (data[i].status ? "可用" : "不可用") +
          "</td><td><button onclick='onDownloadClick(" + data[i].id +
          ")' class='btn btn-outline-primary'>下载</button><button onclick='onDetialClick(" + data[i].id +
          ")' class='btn btn-outline-secondary'>详细</button>" + "<button  onclick=onDeleteClick('" + data[i].id +
          "') class='btn btn-outline-danger'>删除</button></td>" + (data[
            i
          ].dirmask ? ("<td><button onclick='onGetInClick(" + data[i].id +
            ")' class='btn btn-outline-primary'>进入</button></td>") : "<td></td>")

        tdArr.appendChild(tr);
      }

    },
    error: function () {
      serverErrorModal.show()
    }
  })


  $.ajax({
    url: "/api/getUser",
    type: "POST",
    success: function (data) {
      if (null != data && "" != data) {
        document.getElementById("userImg").setAttribute("src", "/api/download?recorid=" + data.imgserviceid)
        document.getElementById("userNickName").innerHTML = data.nickname
      } else {
        alert("获取用户信息失败！")
        window.location.href = '../index.html'
      }
    },
    error: function () {
      alert("获取用户信息失败！")
      window.location.href = '../index.html'
    }
  })

  function onDownloadClick(id) {
    // $.ajax({
    // 	url: "/api/download?recorid=" + id,
    // 	type: "POST",
    // 	success: function(data) {

    // 	},
    // 	error: function() {
    // 		serverErrorModal.show()
    // 	}
    // })
    window.open("/api/download?recorid=" + id)
  }

  function onDetialClick(id) {

    $.ajax({
      url: "/api/queryService?id=" + id,
      type: "POST",
      success: function (data_svr) {
        $.ajax({
          url: "/api/querySysFileTab?id=" + data_svr.sysfilerecordid,
          type: "POST",
          success: function (data) {
            var serInfo = document.getElementById("detialServiceInfo")


            serInfo.innerHTML = "<tr><td>" + data_svr.id + "</td><td>" + data_svr.userid + "</td><td>" +
              data_svr.userfilename + "</td><td>" +
              data_svr.sysfilerecordid + "</td><td>" + data_svr.status +
              "</td><td>" + timestampToTime(data_svr.uploaddate) + "</td><td>" +
              data_svr.parentid + "</td><td>" + data_svr.dirmask + "</td></tr>";

            var SysInfo = document.getElementById("detialSysFileTabInfo")

            SysInfo.innerHTML = "<tr><td>" + data.id + "</td><td>" + data.filename +
              "</td><td>" + data.filehash + "</td><td>" +
              data.location + "</td><td>" + getFileSize(data.filesize) +
              "</td><td>" + data.inuse + "</td><td>" + data.rootmask + "</td></tr>";

            detialModal.show()
          },
          error: function () {
            serverErrorModal.show()
          }
        })
      },
      error: function () {
        serverErrorModal.show()
      }
    })
  }

  var current_md5 = "";
  var filename = "";
  var filehashdone = false;
  var uploadFile_stop = false;


  var log = document.getElementById("log");
  document.getElementById("upload_file").addEventListener("change", function () {
    var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
      file = this.files[0],
      chunkSize = 2097152, // 每次读取2MB
      chunks = Math.ceil(file.size / chunkSize),
      currentChunk = 0,
      spark = new SparkMD5.ArrayBuffer(),
      frOnload = function (e) {
        // log.innerHTML+="\n读取文件 "+parseInt(currentChunk+1)+" of "+chunks;
        var progressRate = (parseInt(currentChunk + 1) / chunks) * 100 + '%'
        // $('.progress_hash > div').css('width',progressRate);
        document.getElementById("filehash_progress").style.width = progressRate;

        spark.append(e.target.result);
        currentChunk++;
        if (currentChunk < chunks) {
          if (uploadFile_stop) {
            uploadFile_stop = false
            return
          }
          loadNext();
        } else {
          current_md5 = spark.end()
          filename = file.name
          filehashdone = true
          log.innerHTML += "\n读取完成！\n\n文件md5:" + current_md5 + "\n";
        }
      },
      frOnerror = function () {
        log.innerHTML += "\n出错了.";
      };

    function loadNext() {
      var fileReader = new FileReader();
      fileReader.onload = frOnload;
      fileReader.onerror = frOnerror;
      var start = currentChunk * chunkSize,
        end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;
      fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
    };
    log.style.display = "inline-block";
    log.innerHTML = "选择文件: " + file.name + " (" + file.size.toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,
      ',') + " bytes)\n";
    loadNext();
  });

  function stopUploadFile() {
    uploadFile_stop = true;
  }

  function uploadFile() {
    if (document.getElementById("upload_file").value.length === 0) {
      alert("请选择一个文件！")
      return
    }

    if (!filehashdone) {
      alert("请等待文件指纹计算完成！")
      return
    }

    var formdata = new FormData()

    formdata.append("file", document.getElementById("upload_file").files[0])
    formdata.append("fileHash", current_md5)
    formdata.append("isDir", false);
    formdata.append("dirName", "")
    formdata.append("fileName", document.getElementById("upload_file").files[0].name)

    $.ajax({
      url: '/api/upload',
      type: 'post',
      data: formdata,
      processData: false,
      contentType: false,
      xhr: function () {
        var xhr = new XMLHttpRequest()

        xhr.upload.addEventListener('progress', function (e) {
          var progressRate = (e.loaded / e.total) * 100 + '%'

          // $('.progress > div').css('width',progressRate);

          document.getElementById("upload_progress").style.width = progressRate;
        })

        return xhr;
      },
      success: function (data) {
        alert(data.errorMsg)
        filehashdone = false;
        location.reload()
      },
      error: function (XMLHttpRequest, textStatus, errorThrown) {
        alert(textStatus);
      }
    });
  }


  var stop = false

  function changeWorkDir(dir) {
    var xhr = new XMLHttpRequest()
    var url = "/api/cd?where=" + dir;

    xhr.open('POST', url, false)
    xhr.send(null)

    var info = xhr.responseText
    var obj = eval("(" + info + ")");
    if (obj.StatusCode === 2000)
      return true;

    return false;
  }

  function createDir(dirname) {
    var formData = new FormData()
    formData.append("file", document.getElementById("upload_dir").files[0])
    formData.append("fileHash", 0)
    formData.append("isDir", true)
    formData.append("dirName", dirname)
    formData.append("fileName", "Unuse")

    var xhr = new XMLHttpRequest()
    xhr.open("POST", "/api/upload", false)
    xhr.send(formData)

    var info = xhr.responseText
    var obj = eval("(" + info + ")");
    if (obj.StatusCode === 2000)
      return true;

    return false;
  }

  function SyncFileReader(file) {
    let self = this;
    let ready = false;
    let result = '';

    const sleep = function (ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    self.readAsBinaryString = async function () {
      while (ready === false) {
        await sleep(100);
      }
      return result;
    }

    const reader = new FileReader();
    reader.onloadend = function (evt) {
      result = evt.target.result;
      ready = true;
    };
    reader.readAsBinaryString(file);
  }

  function uploadDir() {
    // console.log(document.getElementById("upload_dir").files.length)
    // var filelist = document.getElementById("upload_dir").files[0]
    // console.log(filelist.webkitRelativePath.split("/"))
    stop = false

    $.ajax({
      url: "/api/pwd",
      type: "POST",
      success: async function (data) {
        var origin_dir = data;

        var filelist_len = document.getElementById("upload_dir").files.length

        for (var i = 0; i < filelist_len; i++) {
          var current_file = document.getElementById("upload_dir").files[i];
          var current_dirs = current_file.webkitRelativePath.split("/")

          //Try Cd , failed then create and retry
          var dirs_len = current_dirs.length
          // var targetDirInPos = false
          var targetDir = origin_dir
          for (var k = 0; k < (dirs_len - 1); k++) {
            if (targetDir === "/") {
              targetDir = targetDir + current_dirs[k];
            } else {
              targetDir = targetDir + "/" + current_dirs[k];
            }

            if (!changeWorkDir(targetDir)) {
              if (!createDir(current_dirs[k])) {
                alert("创建文件夹：" + current_dirs[k] + "失败！终止动作！")
                // targetDirInPos = false
                changeWorkDir(origin_dir);
                return
              } else if (!changeWorkDir(targetDir)) {
                alert("创建文件夹：" + current_dirs[k] + "成功！但CD失败！终止动作！")
                // targetDirInPos = false
                changeWorkDir(origin_dir);
                return
              }
              // else{
              // 	targetDirInPos = true
              // }
            }
            // else{
            // 	targetDirInPos = true
            // }
          }

          //Dir in pos
          // var hash = hashlist[i]
          // console.log(i)
          console.log("正在读取文件：" + current_file.name);
          const fileReader = new SyncFileReader(current_file);
          const arrayBuffer = await fileReader.readAsBinaryString()


          console.log("读取完毕，正在计算文件指纹。。。");

          var hexHash = new SparkMD5().appendBinary(arrayBuffer).end()
          console.log(hexHash)
          console.log("文件指纹计算完毕，正在上传。。。");

          var formData = new FormData();
          formData.append("file", current_file)
          formData.append("fileHash", hexHash)
          formData.append("isDir", false)
          formData.append("dirName", "emtpy")
          formData.append("fileName", current_dirs[dirs_len - 1])

          var upload_action = document.getElementById("upload_action");
          upload_action.innerHTML = "正在上传：" + current_file.name + "，请等待。。。"
          var xhr = new XMLHttpRequest()
          xhr.open("POST", "/api/upload", false)
          // xhr.upload.addEventListener('progress',function(e){
          // 	var progressRate = (e.loaded / e.total) * 100 + '%'

          // 	// $('.progress > div').css('width',progressRate);

          // 	document.getElementById("uploaddir_progress").style.width = progressRate;
          // })
          xhr.send(formData)

          var info = xhr.responseText
          var obj = eval("(" + info + ")");
          if (obj.StatusCode === 2000) {
            upload_action.innerHTML = current_file.name + "，" + obj.errorMsg
            console.log(current_file.name + "，上传成功！" + obj.errorMsg)
          } else {
            alert("文件：" + current_file.name + "，上传失败！终止动作！")
            alert(obj.errorMsg)
            changeWorkDir(origin_dir);
            return
          }
          //还原最开始工作路径
          // targetDir = origin_dir
        }

        alert("上传完毕！")

        //location.reload()
      },
      error: function () {
        alert("请求PWD错误！服务器异常！");
      }
    })
  }

  function stopUpLoadDir() {
    stop = true;
  }

  function onGetInClick(id) {
    var xhr = new XMLHttpRequest()
    xhr.open("POST", "/api/pwd", false);
    xhr.send(null)

    var pwd = xhr.responseText
    var result = ""

    xhr.open("POST", "/api/queryService?id=" + id, false)
    xhr.send(null)

    var info = xhr.responseText
    var obj = eval("(" + info + ")");

    if (pwd === "/") {
      result = pwd + obj.userfilename;
    } else {
      result = pwd + "/" + obj.userfilename;
    }

    if (changeWorkDir(result)) {
      location.reload()
    } else {
      alert("进入文件夹失败！")
    }
  }

  function onRetClick() {
    var xhr = new XMLHttpRequest()
    xhr.open("POST", "/api/pwd", false);
    xhr.send(null)

    var dir = xhr.responseText

    console.log("之前目录：" + dir)

    dir = dir.substr(0, dir.lastIndexOf("/"))

    if (dir === "") {
      dir = "/"
    }

    console.log("计算结果：" + dir)

    if (changeWorkDir(dir)) {
      location.reload()
    } else {
      alert("返回失败！")
    }

  }

  function onDeleteClick(id) {
    var xhr = new XMLHttpRequest()
    xhr.open("POST", "/api/deleteService?id=" + id, false)
    xhr.send(null)

    location.reload()
  }
</script>

</html>