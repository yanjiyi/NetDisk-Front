<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>分享文件</title>
		<link href="../css/bootstrap.min.css" rel="stylesheet">
		<script src="../js/bootstrap.min.js" type="text/javascript"></script>
		<script src="../js/jquery-3.6.0.min.js" type="text/javascript"></script>
		<script src="../js/utils.js" type="text/javascript"></script>
		<!-- <script src="../js/spark-md5.min.js" type="text/javascript"></script> -->
		<style type="text/css">
			#mainDlg {
				/* width: 80%; */
				margin: 0 auto;
				margin-top: 10%;
				border-radius: 10px;
				box-sizing: border-box;
				background-color: rgba(255, 255, 255, 0.3);
				box-shadow: 0 15px 25px rgba(0, 0, 0, .5);
				padding: 20px;
			}

			.container {
				border-radius: 10px;
				box-sizing: border-box;
				background-color: rgba(255, 255, 255, 0.3);
				box-shadow: 0 15px 25px rgba(0, 0, 0, .5);
				padding: 20px;
				position: absolute;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
			}

			.nav-item {
				margin: 10px 0px;
			}
			
			ul > li {
				list-style: none;
			}
		</style>
	</head>
	<body style="background-image: url(../img/74279906_p0.png);background-attachment: fixed;
					background-size: cover;height: 100%;">
		<div class="container">
			<div class="header" style="height: 80px;">
				<ul>
					<li style="float: left;padding-right: 50px;">
						<ul>
							<li class="nav-item" >
								<img src="../img/QQ图片20210929135729.jpg"
									style="width: 100px;height: 100px;border-radius: 50px;"  id="userImg"/>
							</li>
							<li>
								<span class="text-center" style="color: greenyellow;font-size: 30px;line-height: 30px;" id="userNickName">酸奶红豆包</span>
							</li>
						</ul>
					</li>
					<li style="float: left;">
						<nav nav class="navbar navbar-light"
							style="background-color: #e3f2fd;background-color: transparent;height: 80px;line-height: 80px;">
							<!-- <div class="container-fluid">
						
							</div> -->
							<ul class="nav nav-pills">
								<li class="nav-item">
									<a class="nav-link" href="filelist.html">文件列表</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="friends.html">好友列表</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="tasks.html">我的事务</a>
								</li>
								<li class="nav-item">
									<a class="nav-link active" aria-current="page" href="#">分享文件</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" href="userprofile.html">个人信息</a>
								</li>
							</ul>
						</nav>
					</li>
				</ul>
			</div>
			<div id="mainDlg" class="text-center bg-gradient tab-content">
				<!-- 					<h2 style="">Title</h2> -->
				<table class="table table-borderless table-hover table-striped table-responsive" id="files_container">
					<tr class="table-active">
						<td>文件名</td>
						<td>文件类型</td>
						<td>上传日期</td>
						<td>状态</td>
						<td>操作</td>
						<td></td>
					</tr>
				</table>
			</div>
		</div>

		<div class="modal fadev" id="serverErrorModal" tabindex="-1" aria-labelledby="serverErrorModal"
			aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="serverErrorModal">服务器错误</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<h2 class="bg-danger">请求服务器异常！</h2>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="detialModal" tabindex="-1" aria-labelledby="detialModal" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="detialModal">详细信息</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<h5 class="text-center">Service表信息</h5>
						<table class="table table-borderless table-hover" id="detialServiceInfo">
							<tr>
								<td>ID</td>
								<td>用户ID</td>
								<td>文件名</td>
								<td>系统文件表ID</td>
								<td>状态</td>
								<td>上传日期</td>
								<td>父Service记录ID</td>
								<td>是否是文件夹</td>
							</tr>
						</table>
						<h5 class="text-center">系统文件表信息</h5>
						<table class="table table-borderless table-hover" id="detialSysFileTabInfo">
							<tr>
								<td>ID</td>
								<td>文件名</td>
								<td>文件MD5</td>
								<td>文件位置</td>
								<td>文件大小</td>
								<td>启用</td>
								<td>Root标志</td>
							</tr>
						</table>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			var serverErrorModal = new bootstrap.Modal(document.getElementById('serverErrorModal'), {
				keyboard: false
			})

			var detialModal = new bootstrap.Modal(document.getElementById('detialModal'), {
				keyboard: false
			})


			var filelist_pages = []
			var spilt_size = 10
			var cur_page = 0;

			$.ajax({
				type: "POST",
				url: "/api/listCur",
				success: function(data) {
					var cur_step = 1;
					var page = []
					for (var file in data) {
						if (cur_step <= 10) {
							page.append(file)
							cur_step++
						}

						if (cur_step == 10) {
							filelist_pages.append(page)
							page.clear()
						}
					}

					var tdArr = document.getElementById("files_container").firstElementChild
					for (var i = 0; i < spilt_size; i++) {
						var tr = document.createElement("tr");
						tr.innerHTML = "<td>" + filelist_pages[cur_page][i].userfilename + "</td>" + "<td>" + (filelist_pages[cur_page][i].dirmask ? "文件夹" : "文件") + "</td>" + "<td>" + timestampToTime(filelist_pages[cur_page][i].uploaddate) + "</td><td>" + (filelist_pages[cur_page][i].status ? "可用" : "不可用") + "</td><td><button onclick='onDownloadClick(" + filelist_pages[cur_page][i].id + ")' class='btn btn-outline-primary'>分享</button><button onclick='onDetialClick(" + filelist_pages[cur_page][i].id + ")' class='btn btn-outline-secondary'>详细</button></td>" + (filelist_pages[cur_page][i].dirmask ? "<td><button onclick='onGetInClick(" + filelist_pages[cur_page][i].id + ")' class='btn btn-outline-primary'>进入</button></td>" : "<td></td>")
						// tr.innerHTML = '<td>' + filelist_pages[cur_page][i].userfilename + '</td><td>' +
						// 	filelist_pages[cur_page][i].dirmask ? '文件夹' : '文件' + '</td><td>' + timestampToTime(
						// 		filelist_pages[cur_page][i].uploaddate) + '</td><td>' + filelist_pages[cur_page][i]
						// 	.status ? '可用' : '不可用' + '</td><td><button onclick="onShareClick(' + filelist_pages[
						// 		cur_page][i].id +
						// 	')" class="btn btn-outline-primary">分享</button><button onclick="onDetialClick(' +
						// 	filelist_pages[cur_page][i].id +
						// 	')" class="btn btn-outline-secondary">详细</button></td>' +
						// 	filelist_pages[cur_page][i].dirmask ? '<td><button onclick="onGetInClick(' +
						// 	filelist_pages[cur_page][i].id + ')" class="btn btn-outline-primary">进入</button></td>' :
						// 	'';
						tdArr.appendChild(tr);
					}

				},
				error: function() {
					serverErrorModal.show()
				}
			})

			$.ajax({
				url: "/api/getUser",
				type: "POST",
				success: function(data) {
					if (null != data && "" != data) {
						document.getElementById("userImg").setAttribute("src", "/api/download?recorid=" + data
							.imgserviceid)
						document.getElementById("userNickName").innerHTML = data.nickname
					} else {
						alert("获取用户信息失败！")
						window.location.href = '../index.html'
					}
				},
				error: function() {
					alert("获取用户信息失败！")
					window.location.href = '../index.html'
				}
			})

			function updateTable() {
				var tab = document.getElementById("files_container");
				var i = 0;
				for (var cur_row = 1; cur_row < 11; cur_row++) {
					var uRow = tab.rows[cur_row];
					uRow.innerHTML = "<td>" + filelist_pages[cur_page][i].userfilename + "</td><td>" + filelist_pages[cur_page][
							i]
						.dirmask ? "文件夹" : "文件" + "</td><td>" + timestampToTime(filelist_pages[cur_page][i].uploaddate) +
						"</td><td>" + filelist_pages[cur_page][i].status ? "可用" : "不可用" +
						"</td><td><button onclick='onDownloadClick(" + filelist_pages[cur_page][i].id +
						")' class='btn btn-outline-primary'>下载</button><button onclick='onDetialClick(" + filelist_pages[
							cur_page]
						[i].id + ")' class='btn btn-outline-secondary'>详细</button></td>" +
						filelist_pages[cur_page][i].dirmask ? '<td><button onclick="onGetInClick(' + filelist_pages[cur_page][i]
						.id + ')" class="btn btn-outline-primary">进入</button></td>' : '';
					i++;
				}
			}

			function onfront() {
				if (filelist_pages.length === 0)
					return;

				cur_page--;
				if (cur_page < 0) {
					cur_page = filelist_pages.length
				}

				updateTable()
			}

			function onback() {
				if (filelist_pages.length === 0)
					return;

				cur_page++;
				if (cur_page > filelist_pages.length) {
					cur_page = 0;
				}

				updateTable()
			}

			function onShareClick(id) {

			}

			function onDetialClick(id) {
				$.ajax({
					url: "/api/queryService?id=" + id,
					type: "POST",
					success: function(data_svr) {
						$.ajax({
							url: "/api/querySysFileTab?id=" + data_svr.sysfilerecordid,
							type: "POST",
							success: function(data) {
								var serInfo = document.getElementById("detialServiceInfo")
									.firstElementChild
								serInfo.innerHTML = "<tr><td>" + data_svr.id + "</td><td>" + data_svr
									.userid + "</td><td>" + data_svr.userfilename + "</td><td>" +
									data_svr.sysfilerecordid + "</td><td>" + data_svr.status +
									"</td><td>" + timestampToTime(data_svr.uploaddate) + "</td><td>" +
									data_svr.parentid + "</td><td>" + data_svr.dirmask + "</td></tr>";

								var SysInfo = document.getElementById("detialSysFileTabInfo")
									.firstElementChild
								SysInfo.innerHTML = "<tr><td>" + data.id + "</td><td>" + data.filename +
									"</td><td>" + data.filehash + "</td><td>" +
									data.location + "</td><td>" + getFileSize(data.filesize) +
									"</td><td>" + data.inuse + "</td><td>" + data.rootmask +
									"</td></tr>";

								detialModal.show()
							},
							error: function() {
								serverErrorModal.show()
							}
						})
					},
					error: function() {
						serverErrorModal.show()
					}
				})
			}
		</script>
	</body>
</html>
